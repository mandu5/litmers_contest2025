// Prisma Schema for Jira Lite MVP
// AI-Powered Issue Tracking Application

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User & Authentication
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  password      String?   // Null for OAuth users
  profileImage  String?
  emailVerified DateTime?
  provider      String    @default("credentials") // credentials, google
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime? // Soft delete
  
  // Relations
  accounts      Account[]
  sessions      Session[]
  
  // Team relations
  ownedTeams    Team[]          @relation("TeamOwner")
  teamMembers   TeamMember[]
  teamInvites   TeamInvite[]    @relation("InvitedUser")
  sentInvites   TeamInvite[]    @relation("InvitedBy")
  
  // Project relations
  ownedProjects    Project[]       @relation("ProjectOwner")
  favoriteProjects FavoriteProject[]
  
  // Issue relations
  createdIssues    Issue[]         @relation("IssueCreator")
  assignedIssues   Issue[]         @relation("IssueAssignee")
  issueChanges     IssueHistory[]
  
  // Comment relations
  comments      Comment[]
  
  // Notification relations
  notifications Notification[]
  
  // Activity log
  activities    ActivityLog[]
  
  // AI rate limiting
  aiUsage       AIUsage[]

  @@index([email])
  @@index([deletedAt])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@index([email])
}

// ============================================
// Team Management
// ============================================

model Team {
  id        String    @id @default(cuid())
  name      String
  ownerId   String
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete
  
  // Relations
  owner     User        @relation("TeamOwner", fields: [ownerId], references: [id])
  members   TeamMember[]
  invites   TeamInvite[]
  projects  Project[]
  activities ActivityLog[]

  @@index([ownerId])
  @@index([deletedAt])
}

enum TeamRole {
  OWNER
  ADMIN
  MEMBER
}

model TeamMember {
  id        String   @id @default(cuid())
  teamId    String
  userId    String
  role      TeamRole @default(MEMBER)
  
  joinedAt  DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

model TeamInvite {
  id          String   @id @default(cuid())
  teamId      String
  email       String
  invitedById String
  token       String   @unique
  
  expiresAt   DateTime
  acceptedAt  DateTime?
  
  createdAt   DateTime @default(now())
  
  // Relations
  team        Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  invitedBy   User     @relation("InvitedBy", fields: [invitedById], references: [id])
  invitedUser User?    @relation("InvitedUser", fields: [email], references: [email])

  @@index([teamId])
  @@index([email])
  @@index([token])
}

// ============================================
// Project Management
// ============================================

model Project {
  id          String    @id @default(cuid())
  name        String
  description String?   @db.Text
  teamId      String
  ownerId     String
  isArchived  Boolean   @default(false)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime? // Soft delete
  
  // Relations
  team        Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  owner       User      @relation("ProjectOwner", fields: [ownerId], references: [id])
  issues      Issue[]
  labels      Label[]
  statuses    CustomStatus[]
  favorites   FavoriteProject[]

  @@index([teamId])
  @@index([ownerId])
  @@index([deletedAt])
  @@index([isArchived])
}

model FavoriteProject {
  id        String   @id @default(cuid())
  userId    String
  projectId String
  
  createdAt DateTime @default(now())
  
  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
  @@index([userId])
  @@index([projectId])
}

model CustomStatus {
  id        String   @id @default(cuid())
  name      String
  color     String?
  position  Int
  projectId String
  wipLimit  Int?     // Work in Progress limit
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, name])
  @@index([projectId])
}

model Label {
  id        String   @id @default(cuid())
  name      String
  color     String
  projectId String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  issues    IssueLabel[]

  @@unique([projectId, name])
  @@index([projectId])
}

// ============================================
// Issue Management
// ============================================

enum Priority {
  HIGH
  MEDIUM
  LOW
}

enum IssueStatus {
  BACKLOG
  IN_PROGRESS
  DONE
}

model Issue {
  id          String      @id @default(cuid())
  title       String
  description String?     @db.Text
  status      IssueStatus @default(BACKLOG)
  customStatusId String?  // For custom statuses
  priority    Priority    @default(MEDIUM)
  position    Int         @default(0)
  dueDate     DateTime?
  
  projectId   String
  creatorId   String
  assigneeId  String?
  
  // AI Cache
  aiSummary           String? @db.Text
  aiSuggestion        String? @db.Text
  aiSummaryCachedAt   DateTime?
  aiSuggestionCachedAt DateTime?
  aiCommentSummary    String? @db.Text
  aiCommentSummaryCachedAt DateTime?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime? // Soft delete
  
  // Relations
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  creator     User      @relation("IssueCreator", fields: [creatorId], references: [id])
  assignee    User?     @relation("IssueAssignee", fields: [assigneeId], references: [id])
  
  labels      IssueLabel[]
  subtasks    Subtask[]
  comments    Comment[]
  history     IssueHistory[]

  @@index([projectId])
  @@index([creatorId])
  @@index([assigneeId])
  @@index([status])
  @@index([deletedAt])
  @@index([position])
}

model IssueLabel {
  id        String   @id @default(cuid())
  issueId   String
  labelId   String
  
  createdAt DateTime @default(now())
  
  // Relations
  issue     Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)
  label     Label    @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@unique([issueId, labelId])
  @@index([issueId])
  @@index([labelId])
}

model Subtask {
  id          String   @id @default(cuid())
  title       String
  isCompleted Boolean  @default(false)
  position    Int      @default(0)
  issueId     String
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  issue       Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@index([issueId])
  @@index([position])
}

model IssueHistory {
  id          String   @id @default(cuid())
  issueId     String
  userId      String
  field       String   // status, assignee, priority, title, dueDate
  oldValue    String?
  newValue    String?
  
  createdAt   DateTime @default(now())
  
  // Relations
  issue       Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id])

  @@index([issueId])
  @@index([createdAt])
}

// ============================================
// Comments
// ============================================

model Comment {
  id        String    @id @default(cuid())
  content   String    @db.Text
  issueId   String
  authorId  String
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete
  
  // Relations
  issue     Issue     @relation(fields: [issueId], references: [id], onDelete: Cascade)
  author    User      @relation(fields: [authorId], references: [id])

  @@index([issueId])
  @@index([authorId])
  @@index([deletedAt])
}

// ============================================
// Notifications
// ============================================

enum NotificationType {
  ISSUE_ASSIGNED
  COMMENT_ADDED
  DUE_DATE_APPROACHING
  DUE_DATE_TODAY
  TEAM_INVITE
  ROLE_CHANGED
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  link      String?
  isRead    Boolean          @default(false)
  
  createdAt DateTime         @default(now())
  
  // Relations
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

// ============================================
// Activity Log
// ============================================

enum ActivityType {
  MEMBER_JOINED
  MEMBER_LEFT
  MEMBER_KICKED
  ROLE_CHANGED
  PROJECT_CREATED
  PROJECT_DELETED
  PROJECT_ARCHIVED
  PROJECT_RESTORED
  TEAM_UPDATED
}

model ActivityLog {
  id          String       @id @default(cuid())
  teamId      String
  userId      String
  type        ActivityType
  description String
  metadata    Json?
  
  createdAt   DateTime     @default(now())
  
  // Relations
  team        Team         @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user        User         @relation(fields: [userId], references: [id])

  @@index([teamId])
  @@index([createdAt])
}

// ============================================
// AI Rate Limiting
// ============================================

model AIUsage {
  id        String   @id @default(cuid())
  userId    String
  date      DateTime @db.Date
  count     Int      @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}
